{% extends "base.html" %}
{% load i18n %}

{% block title %}{% trans "Registrar Avance por Lotes (BIM)" %}{% endblock %}

{% block content %}
<div class="container mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2>{% trans "Registrar Avance Múltiple (BIM)" %}</h2>
    </div>

    <p>{% trans "Selecciona uno o varios elementos del MISMO TIPO (ej. varios Largeros). Se aplicarán las mismas fechas a todos." %}</p>
    <hr>

    {% if messages %}
        {% for message in messages %}
            <div class="alert {% if message.tags %}alert-{{ message.tags }}{% else %}alert-info{% endif %} alert-dismissible fade show" role="alert">
                {{ message }}
                <button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>
            </div>
        {% endfor %}
    {% endif %}

    <div class="card">
        <div class="card-header">
            <strong>{% trans "Selección Múltiple y Registro" %}</strong>
        </div>
        <div class="card-body">
            <form method="post" id="avance-bim-form">
                {% csrf_token %}

                {# 1. Campo de selección Múltiple #}
                <div class="mb-4">
                    <label class="form-label">Buscar Elementos:</label>
                    {# Agregamos el atributo multiple #}
                    <select id="select-elementos-bim" multiple placeholder="Escribe para buscar (ej. Largero)..." autocomplete="off"></select>
                    <small class="form-text text-muted">Puedes seleccionar múltiples elementos para registrar su avance simultáneamente.</small>
                </div>

                {# 2. Campo oculto que almacenará los IDs separados por coma (ej: "10,14,25") #}
                <input type="hidden" name="elementos_ids" id="elementos_ids_hidden">

                {# 3. Contenedor de pasos (Dinámico) #}
                <div id="pasos-container" class="mt-4 border-top pt-4" style="display: none;">
                    <h4 id="titulo-pasos">{% trans "Pasos del Proceso Constructivo" %}</h4>
                    <p><small>{% trans "Introduce la fecha de finalización. Se aplicará a TODOS los elementos seleccionados." %}</small></p>
                    
                    <div id="dynamic-fields-target">
                        <p id="loading-indicator" style="display: none;"><span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> {% trans "Cargando pasos..." %}</p>
                    </div>
                </div>

                <hr>
                <button type="submit" class="btn btn-primary" id="save-button" disabled>{% trans "Guardar Avance en Lote" %}</button>
            </form>
        </div>
    </div>
</div>

<link href="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/css/tom-select.bootstrap5.min.css" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/tom-select@2.3.1/dist/js/tom-select.complete.min.js"></script>

<script>
document.addEventListener('DOMContentLoaded', function() {
    const selectElement = document.getElementById('select-elementos-bim');
    const hiddenInput = document.getElementById('elementos_ids_hidden');
    const pasosContainer = document.getElementById('pasos-container');
    const dynamicFieldsTarget = document.getElementById('dynamic-fields-target');
    const saveButton = document.getElementById('save-button');
    const loadingIndicator = document.getElementById('loading-indicator');

    const searchUrl = '{{ url_buscar_elementos }}';
    const urlTemplate = '{{ url_obtener_pasos_base }}';

    // Variable para rastrear el tipo de elemento del primer item seleccionado
    // Esto es para evitar mezclar tipos (ej. Zapatas con Columnas)
    let currentFirstElementId = null; 

    const tomSelect = new TomSelect(selectElement, {
        valueField: 'id',
        labelField: 'text',
        searchField: 'text',
        maxItems: null, // ¡Permite selección infinita!
        plugins: ['remove_button'], // Botón 'x' para quitar elementos
        load: function(query, callback) {
            if (!query.length || query.length < 2) return callback();
            fetch(`${searchUrl}?term=${encodeURIComponent(query)}`)
                .then(response => response.json())
                .then(json => callback(json))
                .catch(()=>{ callback(); });
        },
        render: {
            option: function(item, escape) { return `<div>${escape(item.text)}</div>`; },
            item: function(item, escape) { return `<div>${escape(item.text)}</div>`; }
        },
        onChange: function(values) {
            // values es un array de strings ["1", "5", "9"]
            
            if (values && values.length > 0) {
                // Actualizar input oculto para enviarlo al backend
                hiddenInput.value = values.join(',');

                // Usamos el PRIMER elemento seleccionado para cargar la estructura de pasos
                // Asumimos que el usuario es responsable y selecciona elementos del mismo tipo.
                // El backend hará la validación final.
                const firstId = values[0];
                
                // Si cambiamos de 0 a 1 elemento, o si el primer elemento cambió (podría ser otro tipo)
                if (currentFirstElementId !== firstId) {
                    currentFirstElementId = firstId;
                    fetchPasosYAvance(firstId); 
                }
                
                saveButton.disabled = false;
            } else {
                // Si borra todo
                hiddenInput.value = '';
                pasosContainer.style.display = 'none';
                dynamicFieldsTarget.innerHTML = '';
                saveButton.disabled = true;
                currentFirstElementId = null;
            }
        }
    });

    function fetchPasosYAvance(elementoId) {
        loadingIndicator.style.display = 'block';
        dynamicFieldsTarget.innerHTML = ''; 
        pasosContainer.style.display = 'block';

        const url = urlTemplate.replace('0', elementoId);

        fetch(url)
            .then(response => response.json())
            .then(data => {
                loadingIndicator.style.display = 'none';
                if (data.pasos && data.pasos.length > 0) {
                    renderDynamicFields(data.pasos);
                } else {
                    dynamicFieldsTarget.innerHTML = '<p class="text-muted">{% trans "No hay pasos definidos." %}</p>';
                }
            })
            .catch(error => {
                loadingIndicator.style.display = 'none';
                console.error(error);
            });
    }

    function renderDynamicFields(pasos) {
        dynamicFieldsTarget.innerHTML = '';
        
        // Nota: Al ser múltiple, NO pre-llenamos fechas (value), 
        // porque los elementos podrían tener estados diferentes.
        // Dejamos los campos vacíos para registrar NUEVOS avances.
        
        const alertInfo = document.createElement('div');
        alertInfo.className = "alert alert-warning py-2";
        alertInfo.innerHTML = "<small>Nota: Al editar múltiples elementos, los campos aparecen vacíos. Ingresa una fecha solo donde quieras actualizar el avance.</small>";
        dynamicFieldsTarget.appendChild(alertInfo);

        pasos.forEach(paso => {
            const div = document.createElement('div');
            div.className = 'mb-3 row align-items-center';

            const label = document.createElement('label');
            label.className = 'col-sm-4 col-form-label';
            label.textContent = `${paso.orden}. ${paso.nombre_proceso}:`;
            div.appendChild(label);

            const inputDiv = document.createElement('div');
            inputDiv.className = 'col-sm-8';

            const hiddenInput = document.createElement('input');
            hiddenInput.type = 'hidden';
            hiddenInput.name = 'paso_id';
            hiddenInput.value = paso.paso_id;
            inputDiv.appendChild(hiddenInput);

            const dateInput = document.createElement('input');
            dateInput.type = 'date';
            dateInput.className = 'form-control form-control-sm';
            dateInput.name = 'fecha_finalizacion';
            // NO establecemos value = paso.fecha_guardada para evitar confusiones en bulk
            
            inputDiv.appendChild(dateInput);
            div.appendChild(inputDiv);
            dynamicFieldsTarget.appendChild(div);
        });
    }
});
</script>
{% endblock %}