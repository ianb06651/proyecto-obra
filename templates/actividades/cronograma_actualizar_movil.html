{% extends "base.html" %}

{% block title %}Actualizar Cronograma{% endblock %}

{% block content %}

<style>
    .ts-wrapper { width: 100% !important; display: block !important; }
    .ts-control { padding: 12px 15px !important; min-height: 50px !important; font-size: 1.1rem !important; border-radius: 8px !important; }
    .ts-control input { min-width: 200px !important; width: 100% !important; }
    .ts-dropdown { font-size: 1rem !important; border-radius: 8px !important; box-shadow: 0 4px 15px rgba(0,0,0,0.15) !important; margin-top: 5px !important; }
    .ts-dropdown .option { padding: 10px 15px !important; }
</style>

<div class="container mt-2">
    
    <div class="d-flex justify-content-between align-items-center mb-3">
        <h4 class="mb-0 text-primary">Actualizar Avance</h4>
        <a href="{% url 'actividades:cronograma_list' %}" class="btn btn-outline-secondary btn-sm">
            <i class="bi bi-table"></i> Ver Tabla
        </a>
    </div>

    <div class="card shadow-sm border-0">
        <div class="card-body bg-white">
            
            <p class="text-muted small mb-3">Sigue los pasos para encontrar la actividad:</p>

            {# PASO 0: SELECCIONAR ZONA (NUEVO) #}
            <div class="mb-3 p-3 bg-light rounded border">
                <label class="form-label fw-bold text-primary small text-uppercase">1. Selecciona la Zona de Trabajo</label>
                <select id="select-zona" class="form-select form-select-lg fw-bold text-primary">
                    {% for zona in zonas %}
                        <option value="{{ zona.id }}">{{ zona.nombre }}</option>
                    {% empty %}
                        <option value="">No hay zonas creadas</option>
                    {% endfor %}
                </select>
            </div>

            {# PASO 1: Categoría #}
            <div class="mb-3">
                <label class="form-label fw-bold small text-uppercase text-muted">2. Categoría General</label>
                <select id="select-nivel-1" class="form-select form-select-lg">
                    <option value="">-- Selecciona --</option>
                    {% for cat in categorias_nivel_1 %}
                        <option value="{{ cat.id }}">{{ cat.nombre }}</option>
                    {% endfor %}
                </select>
            </div>

            {# PASO 2: Sub-Categoría #}
            <div class="mb-3" id="container-nivel-2" style="display:none;">
                <label class="form-label fw-bold small text-uppercase text-muted">3. Sub-Categoría</label>
                <select id="select-nivel-2" class="form-select form-select-lg" disabled>
                    <option value="">-- Primero selecciona Categoría --</option>
                </select>
            </div>

            {# PASO 3: Actividad Final #}
            <div class="mb-4" id="container-nivel-3" style="display:none;">
                <label class="form-label fw-bold small text-uppercase text-muted">4. Actividad Final</label>
                <select id="select-nivel-3" placeholder="Buscar actividad..." autocomplete="off">
                    <option value="">Buscar actividad...</option>
                </select>
            </div>

            <hr class="my-4">

            {# FORMULARIO DE EDICIÓN #}
            <form method="post" id="form-edicion" style="display:none;">
                {% csrf_token %}
                <input type="hidden" name="tarea_id" id="input-tarea-id">
                <input type="hidden" name="zona_id" id="input-zona-id"> {# CAMPO OCULTO IMPORTANTE #}

                <div class="alert alert-info border-0 d-flex align-items-center">
                    <i class="bi bi-pencil-fill me-2"></i>
                    <div>
                        <small class="d-block text-uppercase text-muted" style="font-size: 0.7rem;">Editando:</small>
                        <strong id="titulo-tarea-seleccionada">Actividad</strong>
                    </div>
                </div>

                <div class="row g-3">
                    <div class="col-6">
                        <label class="form-label fw-bold small">Inicio Real</label>
                        <input type="date" name="fecha_inicio_real" id="input-inicio" class="form-control form-control-lg border-primary shadow-sm">
                    </div>
                    <div class="col-6">
                        <label class="form-label fw-bold small">Fin Real</label>
                        <input type="date" name="fecha_fin_real" id="input-fin" class="form-control form-control-lg border-success shadow-sm">
                    </div>
                </div>

                <div class="d-grid mt-4">
                    <button type="submit" class="btn btn-primary btn-lg py-3 shadow">
                        Guardar Avance
                    </button>
                </div>
            </form>

        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/tom-select@2.2.2/dist/js/tom-select.complete.min.js"></script>
<script>
document.addEventListener('DOMContentLoaded', function() {
    
    const selZona = document.getElementById('select-zona'); // Nuevo
    const selNivel1 = document.getElementById('select-nivel-1');
    const selNivel2 = document.getElementById('select-nivel-2');
    const divNivel2 = document.getElementById('container-nivel-2');
    const divNivel3 = document.getElementById('container-nivel-3');
    
    // Elementos del formulario
    const formEdicion = document.getElementById('form-edicion');
    const inputTareaId = document.getElementById('input-tarea-id');
    const inputZonaId = document.getElementById('input-zona-id'); // Nuevo
    const tituloTarea = document.getElementById('titulo-tarea-seleccionada');
    const inputInicio = document.getElementById('input-inicio');
    const inputFin = document.getElementById('input-fin');

    let tomSelectNivel3 = new TomSelect('#select-nivel-3', {
        valueField: 'id', labelField: 'nombre', searchField: 'nombre', create: false,
        sortField: {field: "nombre", direction: "asc"}, placeholder: "Escribe para buscar..."
    });

    // Resetear formulario si cambia algo importante
    function resetForm() {
        formEdicion.style.display = 'none';
        tomSelectNivel3.clear();
    }

    // Al cambiar zona, reseteamos la selección final para obligar a recargar datos
    selZona.addEventListener('change', resetForm);

    selNivel1.addEventListener('change', function() {
        const padreId = this.value;
        resetForm();
        
        selNivel2.innerHTML = '<option value="">Cargando...</option>';
        selNivel2.disabled = true;
        divNivel2.style.display = 'block';
        divNivel3.style.display = 'none';
        
        tomSelectNivel3.clearOptions();

        if (padreId) {
            fetch(`/api/cronograma/hijos/${padreId}/`)
                .then(res => res.json())
                .then(data => {
                    selNivel2.innerHTML = '<option value="">-- Selecciona Sub-Categoría --</option>';
                    if(data.length === 0) selNivel2.innerHTML = '<option value="">(Sin sub-categorías)</option>';
                    data.forEach(item => selNivel2.innerHTML += `<option value="${item.id}">${item.nombre}</option>`);
                    selNivel2.disabled = false;
                });
        }
    });

    selNivel2.addEventListener('change', function() {
        const padreId = this.value;
        resetForm();
        divNivel3.style.display = 'none';
        tomSelectNivel3.clearOptions();

        if (padreId) {
            divNivel3.style.display = 'block';
            fetch(`/api/cronograma/hijos/${padreId}/`)
                .then(res => res.json())
                .then(data => { data.forEach(item => tomSelectNivel3.addOption(item)); });
        }
    });

    // CUANDO SE SELECCIONA LA ACTIVIDAD FINAL
    tomSelectNivel3.on('change', function(tareaId) {
        const zonaId = selZona.value; // Obtenemos la zona seleccionada arriba

        if (tareaId && zonaId) {
            // Llamamos a la API enviando Tarea Y Zona
            fetch(`/api/cronograma/detalle/${tareaId}/?zona_id=${zonaId}`)
                .then(res => res.json())
                .then(data => {
                    // Llenamos los hidden inputs
                    inputTareaId.value = data.id;
                    inputZonaId.value = zonaId;
                    
                    // Texto y fechas
                    tituloTarea.innerText = data.nombre;
                    inputInicio.value = data.fecha_inicio_real || '';
                    inputFin.value = data.fecha_fin_real || '';
                    
                    // Mostrar formulario
                    formEdicion.style.display = 'block';
                    formEdicion.scrollIntoView({ behavior: 'smooth' });
                })
                .catch(error => {
                    console.error(error);
                    alert("Error al cargar los datos de esta actividad en la zona seleccionada.");
                });
        } else if (tareaId && !zonaId) {
            alert("⚠️ Por favor, selecciona una Zona de Trabajo en la parte superior (Paso 1).");
            tomSelectNivel3.clear(); // Limpiar selección para obligar a corregir
        } else {
            formEdicion.style.display = 'none';
        }
    });
});
</script>
{% endblock %}